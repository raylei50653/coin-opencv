# 基於 OpenCV 的硬幣(圓形)偵測 

這是使用 `cv2.HoughCircles` 搭配「區域 ROI 追蹤」與執行緒池加速的影片圓形偵測範例。流程為：週期性做**全域偵測**尋找新圓，其他影格只在前一輪圓附近的 **ROI** 內做**局部偵測**，大幅減少計算量並提升 FPS。

---

## 特色

- ✅ **全域 + ROI 混合偵測**：每 `N` 幀全域掃描，其餘影格在 ROI 內細查。  
- ✅ **執行緒池並行**：多個 ROI 併行呼叫 HoughCircles。  
- ✅ **即時顯示**：在畫面上標示偵測到的方框、圓心座標與平滑 FPS。  
- ✅ **參數易調**：Hough、Canny、半徑範圍與 ROI 大小皆可快速微調。

---

## 環境需求

- Python 3.10+（建議 3.12）
- 依賴套件：`opencv-python`, `numpy`
安裝方式pip或uv（擇一，推薦uv）：

```bash
# pip
pip install opencv-python numpy

# uv
uv pip install opencv-python numpy
```

---

## 檔案與執行

- 主要腳本：`main.py`
- 測試影片：將 `coin.mp4` 放在同一資料夾，或修改程式最上方的 `video_path`

執行：

```bash
python your_script.py
```

操作：
- 按 `q` 或 `ESC` 離開。

輸出：
- 視窗 `Video` 會顯示偵測結果（紅框 + 座標）與即時 FPS。

---

## 重要參數（可直接在程式頂端調整）

| 參數名 | 預設 | 說明 | 建議調整方向 |
|---|---:|---|---|
| `DP` | `1` | Hough 累加器解析度比例（>1 代表降採樣以加速全域偵測） | 提高可加速但易漏檢（1.0–2.0） |
| `MIN_DIST` | `20` | 圓心間最小距離（像素） | 幣多且靠近→稍降；雜訊多→提高 |
| `MIN_R` | `15` | 半徑下限（像素） | 依目標大小調整 |
| `MAX_R` | `80` | 半徑上限（像素） | 依目標大小調整 |
| `P1` | `120` | Canny 高閾值（低閾值=0.5×P1） | 畫面雜訊多→提高 |
| `P2` | `40` | Hough 投票門檻（越小越敏感） | 偵測不到→降低；誤報多→提高（25–60 起手） |
| `DETECT_INTERVAL` | `6` | 每多少幀做一次全域偵測 | 想更快→提高；怕丟失新物體→降低 |
| `ROI_PAD_FACTOR` | `0.35` | ROI 外擴比例（相對半徑） | 目標位移快→提高；要加速→降低 |

---

## 演算法流程

1. **讀取影格 → 灰階 → 高斯模糊（7×7）**  
2. **決策偵測模式**  
   - 每 `DETECT_INTERVAL` 幀或前一輪無圓：**全域 Hough**。  
   - 其他情況：**ROI 偵測**（針對上一輪每顆圓，以外擴的 ROI 做 Hough；多 ROI 以執行緒池並行）。  
3. **繪製結果**：以紅框標記並打印 `(x,y)` 座標；更新 `prev_circles`。  
4. **FPS 平滑**：使用固定長度 `deque` 計算移動平均。

---

## 效能建議

- **半徑範圍**：越貼近實際大小，越快。  
- **DETECT_INTERVAL**：提高可加速，但可能錯過新進物體。  
- **P2**：過低誤報多，過高漏檢。  
- **多執行緒**：`ROIHoughDetector(worker_cap=8)` 可依 CPU 調整。  
- **畫面縮放**：高解析影片可預先縮小。

---

## 常見問題（FAQ）

**Q1. 沒偵測到圓**  
- 降低 `P2` 或放寬半徑範圍。  
- 確認光線充足、邊緣明顯。

**Q2. 誤報多**  
- 提高 `P2`、`MIN_DIST` 或收緊半徑。

**Q3. 畫面卡**  
- 提高 `DETECT_INTERVAL`、增大 `DP`、或降低解析度。

---

## 可選：命令列輸入影片

```python
import sys
if len(sys.argv) > 1:
    video_path = sys.argv[1]
```

---

## 結果示例

左上顯示 FPS，紅框圈出硬幣，印出座標 `(x, y)`。

終端機輸出：

```
影片資訊: 1920x1080, 30.0 FPS
處理完成！
```

---